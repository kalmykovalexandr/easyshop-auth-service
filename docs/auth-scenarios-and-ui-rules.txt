Auth Flows & UI Rules (structured)

General rules
- All user-facing strings come from messages.properties.
- The backend never reveals which credential field is wrong; error payloads stay generic.
- Web UI and external clients (Postman, mobile, etc.) must receive identical HTTP statuses and bodies.
- POST /api/auth/register and POST /api/auth/send-code respond with `{ cooldownSeconds, cooldownUntil, otpStatus }`; the UI uses these values to drive the resend timer.
- Any form with mandatory email/password/confirm-password fields (sign-in, registration, forgot password) shows "Fill all fields." when one or more inputs are empty. The banner disappears when the user focuses the missing field.
- Visible banners (errors or success messages) auto-dismiss roughly after 7 seconds or immediately when the user focuses an input or switches between sign-in and registration.
- Any visible error banner clears immediately once the user clicks within the auth widget or switches to another flow (sign-in/registration/forgot-password).

----------------------------------------------------------------------
Sign-in scenarios

SI-01: Empty form
- Preconditions: user is on `/login`.
- Steps:
  1. Leave email and password empty.
  2. Click "Sign in".
- Expected result:
  - Client-side validation blocks the submission.
  - Banner "Fill all fields." stays visible and focus moves to the email field.
  - No network request is executed.

SI-02: Missing password
- Preconditions: `/login`.
- Steps: enter a valid email, leave password empty, click "Sign in".
- Expected result: "Fill all fields." appears, focus returns to the password field, no request is sent.

SI-03: Missing email
- Preconditions: `/login`.
- Steps: enter a password, leave email empty, click "Sign in".
- Expected result: "Fill all fields." appears, focus returns to the password field, no request is sent.

SI-04: Invalid email format
- Steps: enter a non-email string plus password, click "Sign in".
- Expected result: "Enter a valid e-mail address.", focus returns to the email field; the browser does not submit.

SI-05: Successful sign-in (enabled user)
- Preconditions: account exists, `enabled=true`.
- Steps: supply valid credentials, click "Sign in".
- Expected result: Spring Security issues 302 to the success URL; the resulting page has no `error` query parameter.

SI-06: Invalid credentials or locked account
- Preconditions: wrong credentials or `accountNonLocked=false`.
- Expected result: backend redirects to `/login?error=credentials`, stores last username; UI shows "Invalid e-mail or password. Try again." until the user edits an input.

SI-07: Unverified account, correct password
- Preconditions: account exists, `enabled=false`, password is correct.
- Steps: submit credentials.
- Expected result: backend throws `DisabledException`, redirects to `/login?error=disabled`;
  UI opens the OTP modal, disables resend, calls `/api/auth/send-code`,
  and syncs the timer using the response. After successful `verify-code` (`activateUser=true`) the account becomes enabled and the next sign-in follows SI-05.

SI-08: Unverified account, wrong password
- Preconditions: same as SI-07 but the password is wrong.
- Expected result: backend returns `/login?error=credentials`, OTP modal is not shown; UI displays the generic banner.

SI-09: Remember last username
- Preconditions: at least one failed sign-in happened earlier.
- Expected result: `/login` renders with `SPRING_SECURITY_LAST_USERNAME` pre-filled; user may overwrite it manually.

----------------------------------------------------------------------
Registration scenarios

RG-01: Fresh registration (success)
- Preconditions: email not present in the system.
- Steps: submit valid email plus strong password and confirmation.
- Expected result: backend creates user with `enabled=false`, generates OTP, returns 202 with cooldown info; UI opens the OTP modal, disables resend, starts the countdown; successful `verify-code` with `activateUser=true` activates the account.

RG-02: Repeat registration for unverified user
- Preconditions: user exists, `enabled=false`, OTP still stored (regenerated if expired).
- Steps: register again with the same email.
- Expected result: password is updated; if an OTP is still valid it is resent (otherwise regenerated). Cooldown values are refreshed and the UI restarts the timer without extra banners.

RG-03: Registration for already verified email
- Preconditions: user exists, `enabled=true`.
- Expected result: backend returns `EMAIL_ALREADY_USED` (409/422); UI shows "Email is already registered".

RG-04: Missing required fields
- Steps: leave one or more required inputs empty and click submit.
- Expected result: "Fill all fields.", focus on the first missing input, no request is sent; API callers receive 400 with `*_REQUIRED` codes.

RG-05: Invalid form data
- Cases: invalid email format (`EMAIL_INVALID`), weak password (`PASSWORD_WEAK`), password mismatch (`PASSWORDS_DO_NOT_MATCH`).
- Expected result: backend returns 400 with detailed codes; UI highlights fields and does not open the OTP modal.

RG-06: Resend OTP before cooldown expires
- Steps: press "Resend OTP" while the timer > 0.
- Expected result: `/api/auth/send-code` returns 429 with cooldown payload; UI shows "Please wait {0} seconds..." and keeps the button disabled until countdown ends.

RG-07: Resend OTP after cooldown (OTP still valid)
- Preconditions: cooldown finished, OTP not expired.
- Expected result: backend resends the existing code, returns 202 with new cooldown; UI simply restarts the timer using returned values.

RG-08: Resend OTP after the code expired
- Expected result: backend generates a new OTP, returns 202 with fresh cooldown; UI expects the new code from email.

RG-09: Wrong OTP during confirmation
- Expected result: `/api/auth/verify-code` -> 400 `VERIFICATION_CODE_INVALID`; UI shows "Verification failed. Try again."

RG-10: OTP expired during confirmation
- Expected result: `/api/auth/verify-code` -> 410 `VERIFICATION_CODE_EXPIRED`; UI suggests requesting a new code and re-enables resend.

RG-11: Too many OTP attempts
- Expected result: backend returns 400 `TOO_MANY_VERIFICATION_ATTEMPTS`; UI shows warning, resend remains governed by cooldown.

RG-12: Confirmation without active OTP
- Preconditions: Redis entry missing (cleanup/TTL).
- Expected result: backend returns 404 `VERIFICATION_CODE_NOT_FOUND`; UI instructs the user to request a new code.

----------------------------------------------------------------------
Forgot password scenarios

FP-01: Request reset with empty email
- Steps: open "Forgot password", leave the input empty, click "Send code".
- Expected result: "Enter a valid e-mail." and no request is made.

FP-02: Request reset with invalid email
- Steps: enter a malformed value, click "Send code".
- Expected result: "Enter a valid e-mail.", no network call.

FP-03: Request reset with valid email
- Preconditions: user exists.
- Steps: enter email, click "Send code".
- Expected result: POST `/api/auth/send-code` -> 202 with cooldown; the code modal opens with resend disabled until the response arrives and the timer starts.

FP-04: Empty code submission
- Steps: in the code modal leave the input blank, click "Verify code".
- Expected result: "Enter a valid code."

FP-05: Wrong code
- Expected result: `/api/auth/verify-code` -> 400 `VERIFICATION_CODE_INVALID`; UI shows failure banner.

FP-06: Expired code
- Expected result: `/api/auth/verify-code` -> 410 `VERIFICATION_CODE_EXPIRED`; UI prompts to request a new code.

FP-07: Resend before cooldown
- Steps: click "Resend OTP" before the timer finishes.
- Expected result: backend responds 429 with cooldown payload; UI keeps the button disabled and updates the timer.

FP-08: Resend after cooldown
- Steps: wait for timer to finish, press "Resend OTP".
- Expected result: backend returns 202 with new cooldown; UI restarts the timer immediately when the modal reopens or the response arrives.

FP-09: Reset password form with empty fields
- Steps: leave password or confirmation empty, click "Save password".
- Expected result: "Fill in all fields."

FP-10: Weak or mismatched password
- Expected result: backend returns `PASSWORD_WEAK` or `PASSWORDS_DO_NOT_MATCH`; UI displays the corresponding message.

FP-11: Successful password reset
- Preconditions: valid resetToken.
- Steps: enter new password plus confirmation, click "Save password".
- Expected result: `/api/auth/reset-password` -> 204; UI shows the success modal and clears the token.
